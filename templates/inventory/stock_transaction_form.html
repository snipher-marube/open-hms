{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}{{ title }} - HMS{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">{{ title }}</h1>
                <p class="text-gray-600 mt-1">Record stock movements and transactions</p>
            </div>
            <a href="{% url 'inventory-list' %}" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md transition duration-200">
                Back to Inventory
            </a>
        </div>

        <form method="post" class="space-y-6" id="transaction-form">
            {% csrf_token %}
            
            {% if form.errors %}
            <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                <h3 class="text-red-800 font-semibold mb-2">Please correct the following errors:</h3>
                <ul class="list-disc list-inside text-red-700 text-sm">
                    {% for field, errors in form.errors.items %}
                        {% for error in errors %}
                            <li>{{ field|title }}: {{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Left Column -->
                <div class="space-y-6">
                    <!-- Transaction Details -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-blue-800 mb-3">Transaction Details</h3>
                        
                        {{ form.inventory_item|as_crispy_field }}
                        {{ form.transaction_type|as_crispy_field }}
                        {{ form.quantity|as_crispy_field }}
                        {{ form.unit_price|as_crispy_field }}
                        {{ form.reference|as_crispy_field }}
                    </div>
                </div>

                <!-- Right Column -->
                <div class="space-y-6">
                    <!-- Additional Information -->
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-green-800 mb-3">Additional Information</h3>
                        
                        {{ form.patient|as_crispy_field }}
                        {{ form.prescription|as_crispy_field }}
                        {{ form.notes|as_crispy_field }}
                    </div>

                    <!-- Transaction Guide -->
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-yellow-800 mb-3">Transaction Types Guide</h3>
                        <div class="space-y-2 text-sm text-yellow-700">
                            <div class="flex items-start space-x-2">
                                <span class="font-medium">Purchase:</span>
                                <span>Add stock to inventory (positive quantity)</span>
                            </div>
                            <div class="flex items-start space-x-2">
                                <span class="font-medium">Sale:</span>
                                <span>Remove stock for sales (negative quantity)</span>
                            </div>
                            <div class="flex items-start space-x-2">
                                <span class="font-medium">Return:</span>
                                <span>Return items from customers (negative quantity)</span>
                            </div>
                            <div class="flex items-start space-x-2">
                                <span class="font-medium">Adjustment:</span>
                                <span>Stock count adjustments (positive/negative)</span>
                            </div>
                            <div class="flex items-start space-x-2">
                                <span class="font-medium">Transfer:</span>
                                <span>Move stock between locations (negative quantity)</span>
                            </div>
                            <div class="flex items-start space-x-2">
                                <span class="font-medium">Write Off:</span>
                                <span>Remove damaged/expired stock (negative quantity)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Current Stock Display -->
            <div id="current-stock-info" class="bg-gray-50 border border-gray-200 rounded-lg p-4 hidden">
                <h4 class="font-semibold text-gray-800 mb-2">Current Stock Information</h4>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div>
                        <span class="text-gray-600">Current Stock:</span>
                        <span id="current-stock" class="font-medium ml-2">-</span>
                    </div>
                    <div>
                        <span class="text-gray-600">Cost Price:</span>
                        <span id="cost-price" class="font-medium ml-2">-</span>
                    </div>
                    <div>
                        <span class="text-gray-600">Selling Price:</span>
                        <span id="selling-price" class="font-medium ml-2">-</span>
                    </div>
                    <div>
                        <span class="text-gray-600">Expiry Date:</span>
                        <span id="expiry-date" class="font-medium ml-2">-</span>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="flex justify-end space-x-4 pt-6 border-t">
                <a href="{% url 'inventory-list' %}" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-md transition duration-200">
                    Cancel
                </a>
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md transition duration-200">
                    Record Transaction
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const inventoryItemField = document.getElementById('id_inventory_item');
    const transactionTypeField = document.getElementById('id_transaction_type');
    const unitPriceField = document.getElementById('id_unit_price');
    const currentStockInfo = document.getElementById('current-stock-info');
    
    // Update unit price and show stock info when inventory item changes
    if (inventoryItemField) {
        inventoryItemField.addEventListener('change', function() {
            const itemId = this.value;
            
            if (itemId) {
                // Fetch inventory item details
                fetch(`/inventory/api/item/${itemId}/`)
                    .then(response => response.json())
                    .then(data => {
                        // Update stock information display
                        document.getElementById('current-stock').textContent = data.current_stock;
                        document.getElementById('cost-price').textContent = '$' + data.cost_price;
                        document.getElementById('selling-price').textContent = '$' + data.selling_price;
                        document.getElementById('expiry-date').textContent = data.expiry_date;
                        
                        // Show stock info
                        currentStockInfo.classList.remove('hidden');
                        
                        // Set default unit price based on transaction type
                        updateUnitPrice(data);
                    })
                    .catch(error => {
                        console.error('Error fetching inventory item:', error);
                    });
            } else {
                // Hide stock info if no item selected
                currentStockInfo.classList.add('hidden');
            }
        });
    }
    
    // Update unit price when transaction type changes
    if (transactionTypeField) {
        transactionTypeField.addEventListener('change', function() {
            const itemId = inventoryItemField.value;
            if (itemId) {
                // Re-fetch and update unit price
                fetch(`/inventory/api/item/${itemId}/`)
                    .then(response => response.json())
                    .then(data => {
                        updateUnitPrice(data);
                    })
                    .catch(error => {
                        console.error('Error fetching inventory item:', error);
                    });
            }
        });
    }
    
    function updateUnitPrice(itemData) {
        const transactionType = transactionTypeField.value;
        
        if (transactionType === 'purchase') {
            unitPriceField.value = itemData.cost_price;
        } else if (['sale', 'return', 'transfer', 'write_off'].includes(transactionType)) {
            unitPriceField.value = itemData.selling_price;
        } else {
            unitPriceField.value = '0';
        }
    }
    
    // Auto-set quantity sign based on transaction type
    if (transactionTypeField) {
        transactionTypeField.addEventListener('change', function() {
            const quantityField = document.getElementById('id_quantity');
            const currentValue = parseFloat(quantityField.value) || 0;
            
            if (['sale', 'return', 'transfer', 'write_off'].includes(this.value) && currentValue > 0) {
                quantityField.value = -Math.abs(currentValue);
            } else if (['purchase', 'adjustment'].includes(this.value) && currentValue < 0) {
                quantityField.value = Math.abs(currentValue);
            }
        });
    }
    
    // Validate quantity based on transaction type
    const quantityField = document.getElementById('id_quantity');
    if (quantityField) {
        quantityField.addEventListener('change', function() {
            const transactionType = transactionTypeField.value;
            const value = parseFloat(this.value) || 0;
            
            if (['sale', 'return', 'transfer', 'write_off'].includes(transactionType) && value > 0) {
                alert('Warning: Quantity should be negative for ' + transactionType + ' transactions. Automatically converting to negative.');
                this.value = -Math.abs(value);
            } else if (['purchase', 'adjustment'].includes(transactionType) && value < 0) {
                alert('Warning: Quantity should be positive for ' + transactionType + ' transactions. Automatically converting to positive.');
                this.value = Math.abs(value);
            }
        });
    }
});
</script>
{% endblock %}