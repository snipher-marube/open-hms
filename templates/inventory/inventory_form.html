{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}{{ title }} - HMS{% endblock %}

{% block extra_css %}
<style>
    .searchable-select {
        position: relative;
    }
    .search-input {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
    }
    .search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }
    .search-result-item {
        padding: 0.5rem;
        cursor: pointer;
        border-bottom: 1px solid #f3f4f6;
    }
    .search-result-item:hover {
        background-color: #f3f4f6;
    }
    .search-result-item:last-child {
        border-bottom: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">{{ title }}</h1>
                <p class="text-gray-600 mt-1">Add new medicine to inventory with complete details</p>
            </div>
            <a href="{% url 'inventory-list' %}" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md transition duration-200">
                Back to Inventory
            </a>
        </div>

        <form method="post" class="space-y-6" id="inventory-form">
            {% csrf_token %}
            
            {% if form.errors %}
            <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                <h3 class="text-red-800 font-semibold mb-2">Please correct the following errors:</h3>
                <ul class="list-disc list-inside text-red-700 text-sm">
                    {% for field, errors in form.errors.items %}
                        {% for error in errors %}
                            <li>{{ field|title }}: {{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <!-- Form Sections -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Left Column - Basic Information -->
                <div class="space-y-6">
                    <!-- Medicine Section -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-blue-800 mb-3">Medicine Information</h3>
                        
                        <!-- Medicine Selection with Search -->
                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <label for="{{ form.medicine.id_for_label }}" class="block text-sm font-medium text-gray-700">
                                    Medicine *
                                </label>
                                <button type="button" 
                                        onclick="openModal('medicine-modal')" 
                                        class="add-new-btn bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-1 rounded-full flex items-center space-x-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                    <span>Add New</span>
                                </button>
                            </div>
                            <div class="searchable-select">
                                <input type="text" 
                                       id="medicine-search" 
                                       class="search-input" 
                                       placeholder="Type to search medicines..."
                                       autocomplete="off">
                                <div id="medicine-results" class="search-results"></div>
                            </div>
                            {{ form.medicine }}
                        </div>

                        <!-- Category Selection with Search -->
                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <label for="{{ form.category.id_for_label }}" class="block text-sm font-medium text-gray-700">
                                    Category
                                </label>
                                <button type="button" 
                                        onclick="openModal('category-modal')" 
                                        class="add-new-btn bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-1 rounded-full flex items-center space-x-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                    <span>Add New</span>
                                </button>
                            </div>
                            <div class="searchable-select">
                                <input type="text" 
                                       id="category-search" 
                                       class="search-input" 
                                       placeholder="Type to search categories..."
                                       autocomplete="off">
                                <div id="category-results" class="search-results"></div>
                            </div>
                            {{ form.category }}
                        </div>

                        <!-- Batch Number -->
                        <div class="mb-4">
                            {{ form.batch_number|as_crispy_field }}
                        </div>

                        <!-- Supplier Selection with Search -->
                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <label for="{{ form.supplier.id_for_label }}" class="block text-sm font-medium text-gray-700">
                                    Supplier
                                </label>
                                <button type="button" 
                                        onclick="openModal('supplier-modal')" 
                                        class="add-new-btn bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-1 rounded-full flex items-center space-x-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                    <span>Add New</span>
                                </button>
                            </div>
                            <div class="searchable-select">
                                <input type="text" 
                                       id="supplier-search" 
                                       class="search-input" 
                                       placeholder="Type to search suppliers..."
                                       autocomplete="off">
                                <div id="supplier-results" class="search-results"></div>
                            </div>
                            {{ form.supplier }}
                        </div>
                    </div>

                    <!-- Stock Information -->
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-green-800 mb-3">Stock Information</h3>
                        {{ form.quantity|as_crispy_field }}
                        {{ form.location|as_crispy_field }}
                        {{ form.status|as_crispy_field }}
                    </div>
                </div>

                <!-- Right Column - Pricing & Dates -->
                <div class="space-y-6">
                    <!-- Pricing & Dates -->
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-purple-800 mb-3">Pricing & Dates (in Ksh)</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            {{ form.cost_price|as_crispy_field }}
                            {{ form.selling_price|as_crispy_field }}
                        </div>

                        {{ form.expiry_date|as_crispy_field }}

                        <!-- Profit Margin Display -->
                        <div id="profit-margin-display" class="p-3 bg-purple-100 rounded-lg hidden mt-4">
                            <p class="text-sm font-medium">
                                Profit Margin: <span id="margin-value">0</span>%
                                <span id="margin-status" class="text-xs ml-2"></span>
                            </p>
                        </div>
                    </div>

                    <!-- Stock Levels -->
                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-orange-800 mb-3">Stock Levels</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            {{ form.min_stock_level|as_crispy_field }}
                            {{ form.max_stock_level|as_crispy_field }}
                        </div>
                        
                        <div class="p-3 bg-orange-100 rounded-lg">
                            <p class="text-sm text-orange-800">
                                <strong>Note:</strong> Low stock alerts will trigger when quantity falls below the minimum level.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="flex justify-end space-x-4 pt-6 border-t">
                <a href="{% url 'inventory-list' %}" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-md transition duration-200">
                    Cancel
                </a>
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md transition duration-200">
                    {% if item %}Update Item{% else %}Add to Inventory{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Include Modals -->
{% include 'inventory/modals/medicine_modal.html' %}
{% include 'inventory/modals/category_modal.html' %}
{% include 'inventory/modals/supplier_modal.html' %}

<!-- Help Section -->
<div class="mt-6 bg-gray-50 rounded-lg p-6">
    <h3 class="text-lg font-semibold text-gray-800 mb-3">Inventory Management Tips</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600">
        <div class="flex items-start space-x-2">
            <svg class="w-5 h-5 text-green-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span>Set appropriate minimum stock levels to avoid running out of critical medicines</span>
        </div>
        <div class="flex items-start space-x-2">
            <svg class="w-5 h-5 text-green-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span>Always check expiry dates and use FIFO (First-In-First-Out) principle</span>
        </div>
        <div class="flex items-start space-x-2">
            <svg class="w-5 h-5 text-green-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span>Regularly update stock levels after prescriptions are dispensed</span>
        </div>
        <div class="flex items-start space-x-2">
            <svg class="w-5 h-5 text-green-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span>Monitor profit margins to ensure sustainable pricing</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Modal Functions
function openModal(modalId) {
    document.getElementById(modalId).classList.remove('hidden');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.add('hidden');
}

// Close modal when clicking outside
window.onclick = function(event) {
    if (event.target.classList.contains('fixed')) {
        event.target.classList.add('hidden');
    }
}

// Search and Autocomplete Functionality
function setupSearchableSelect(searchInputId, resultsId, selectId, searchUrl) {
    const searchInput = document.getElementById(searchInputId);
    const resultsDiv = document.getElementById(resultsId);
    const selectElement = document.getElementById(selectId);
    
    if (!searchInput || !resultsDiv || !selectElement) return;
    
    // Hide the original select and show search input
    selectElement.style.display = 'none';
    searchInput.style.display = 'block';
    
    searchInput.addEventListener('input', function() {
        const query = this.value.trim();
        
        if (query.length < 2) {
            resultsDiv.style.display = 'none';
            return;
        }
        
        fetch(`${searchUrl}?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                resultsDiv.innerHTML = '';
                
                if (data.results && data.results.length > 0) {
                    data.results.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'search-result-item';
                        div.textContent = item.text;
                        div.setAttribute('data-value', item.id);
                        
                        div.addEventListener('click', function() {
                            selectElement.value = this.getAttribute('data-value');
                            searchInput.value = item.text;
                            resultsDiv.style.display = 'none';
                        });
                        
                        resultsDiv.appendChild(div);
                    });
                    resultsDiv.style.display = 'block';
                } else {
                    resultsDiv.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error fetching search results:', error);
            });
    });
    
    // Hide results when clicking outside
    document.addEventListener('click', function(event) {
        if (!searchInput.contains(event.target) && !resultsDiv.contains(event.target)) {
            resultsDiv.style.display = 'none';
        }
    });
}

// Initialize searchable selects when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Setup searchable selects
    setupSearchableSelect(
        'medicine-search', 
        'medicine-results', 
        'id_medicine', 
        '{% url "ajax-search-medicines" %}'
    );
    
    setupSearchableSelect(
        'category-search', 
        'category-results', 
        'id_category', 
        '{% url "ajax-search-categories" %}'
    );
    
    setupSearchableSelect(
        'supplier-search', 
        'supplier-results', 
        'id_supplier', 
        '{% url "ajax-search-suppliers" %}'
    );
    
    // Modal form submissions
    document.getElementById('medicine-form')?.addEventListener('submit', function(e) {
        e.preventDefault();
        submitModalForm(this, 'medicine', 'id_medicine');
    });
    
    document.getElementById('category-form')?.addEventListener('submit', function(e) {
        e.preventDefault();
        submitModalForm(this, 'category', 'id_category');
    });
    
    document.getElementById('supplier-form')?.addEventListener('submit', function(e) {
        e.preventDefault();
        submitModalForm(this, 'supplier', 'id_supplier');
    });
    
    // Profit margin calculation (existing code)
    const costPriceField = document.getElementById('id_cost_price');
    const sellingPriceField = document.getElementById('id_selling_price');
    const marginDisplay = document.getElementById('profit-margin-display');
    const marginValue = document.getElementById('margin-value');
    const marginStatus = document.getElementById('margin-status');
    
    function calculateMargin() {
        const cost = parseFloat(costPriceField.value) || 0;
        const selling = parseFloat(sellingPriceField.value) || 0;
        
        if (cost > 0 && selling > 0) {
            const margin = ((selling - cost) / cost) * 100;
            marginValue.textContent = margin.toFixed(2);
            marginDisplay.classList.remove('hidden');
            
            if (margin < 0) {
                marginDisplay.className = 'p-3 bg-red-100 rounded-lg mt-4';
                marginStatus.textContent = '(Loss)';
                marginStatus.className = 'text-xs ml-2 text-red-600';
            } else if (margin < 10) {
                marginDisplay.className = 'p-3 bg-yellow-100 rounded-lg mt-4';
                marginStatus.textContent = '(Low)';
                marginStatus.className = 'text-xs ml-2 text-yellow-600';
            } else if (margin < 25) {
                marginDisplay.className = 'p-3 bg-green-100 rounded-lg mt-4';
                marginStatus.textContent = '(Good)';
                marginStatus.className = 'text-xs ml-2 text-green-600';
            } else {
                marginDisplay.className = 'p-3 bg-blue-100 rounded-lg mt-4';
                marginStatus.textContent = '(Excellent)';
                marginStatus.className = 'text-xs ml-2 text-blue-600';
            }
        } else {
            marginDisplay.classList.add('hidden');
            marginStatus.textContent = '';
        }
    }
    
    if (costPriceField && sellingPriceField) {
        costPriceField.addEventListener('input', calculateMargin);
        sellingPriceField.addEventListener('input', calculateMargin);
        calculateMargin();
    }
    
    // Auto-set default values
    const minStockField = document.getElementById('id_min_stock_level');
    const maxStockField = document.getElementById('id_max_stock_level');
    
    if (minStockField && !minStockField.value) minStockField.value = '10';
    if (maxStockField && !maxStockField.value) maxStockField.value = '100';
});

// Function to submit modal forms via AJAX
function submitModalForm(form, type, selectId) {
    const formData = new FormData(form);
    
    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Add new option to select
            const select = document.getElementById(selectId);
            const option = new Option(data.object.text, data.object.id, true, true);
            select.add(option);
            
            // Update search input
            const searchInput = document.getElementById(`${type}-search`);
            if (searchInput) {
                searchInput.value = data.object.text;
            }
            
            // Close modal and reset form
            closeModal(`${type}-modal`);
            form.reset();
            
            // Show success message
            showNotification(`${type.charAt(0).toUpperCase() + type.slice(1)} created successfully!`, 'success');
        } else {
            showNotification('Error: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred. Please try again.', 'error');
    });
}

// Notification function
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-md shadow-lg z-50 ${
        type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}
</script>
{% endblock %}